{% extends 'base.html' %}
{% load static %}

{% block title %}Mode Selection - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .mode-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
        height: 100%;
    }
    
    .mode-card:hover {
        border-color: var(--bs-primary);
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .fast-lane-card:hover {
        border-color: #00d4aa;
        box-shadow: 0 10px 25px rgba(0,212,170,0.3);
    }
    
    .smart-lane-card:hover {
        border-color: #6f42c1;
        box-shadow: 0 10px 25px rgba(111,66,193,0.3);
    }
    
    .fast-lane-accent {
        color: #00d4aa !important;
    }
    
    .smart-lane-accent {
        color: #6f42c1 !important;
    }
    
    .performance-metric {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        background: rgba(255,255,255,0.1);
        margin-bottom: 1rem;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        line-height: 1;
    }
    
    .metric-label {
        font-size: 0.875rem;
        opacity: 0.7;
        margin-top: 0.5rem;
    }
    
    .comparison-highlight {
        background: linear-gradient(45deg, #00d4aa, #6f42c1);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
    }
    
    .phase-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .disabled-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-shuffle me-2"></i>Select Trading Mode
                    </h1>
                    <p class="text-muted mb-0">
                        Choose between speed-optimized Fast Lane or intelligence-optimized Smart Lane
                    </p>
                </div>
                <div>
                    {% if is_mock_mode %}
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-info-circle me-1"></i>Demo Mode
                        </span>
                    {% else %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>Live Data
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Mode Cards -->
    <div class="row g-4 mb-5">
        <!-- Fast Lane Mode -->
        <div class="col-lg-6">
            <div class="card card-glass mode-card fast-lane-card h-100 position-relative" 
                 {% if fast_lane_available %}onclick="selectMode('FAST_LANE')"{% endif %}>
                
                {% if not fast_lane_available %}
                <div class="disabled-overlay">
                    <div class="text-center text-white">
                        <i class="bi bi-tools display-4 mb-2"></i>
                        <div class="h5">Under Maintenance</div>
                        <small>Fast Lane temporarily unavailable</small>
                    </div>
                </div>
                {% endif %}
                
                <div class="card-header text-center">
                    <i class="bi bi-lightning-charge fast-lane-accent fs-1 mb-2"></i>
                    <h3 class="fast-lane-accent mb-1">âš¡ Fast Lane</h3>
                    <p class="text-muted mb-0">Speed-Optimized Execution</p>
                </div>
                <div class="card-body">
                    <!-- Performance Metrics -->
                    <div class="row mb-3">
                        <div class="col-4">
                            <div class="performance-metric">
                                <div class="metric-value fast-lane-accent">
                                    {{ fast_lane_metrics.execution_time_ms }}ms
                                </div>
                                <div class="metric-label">Execution</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="performance-metric">
                                <div class="metric-value text-success">
                                    {{ fast_lane_metrics.success_rate }}%
                                </div>
                                <div class="metric-label">Success</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="performance-metric">
                                <div class="metric-value text-info">
                                    {{ fast_lane_metrics.trades_per_minute }}
                                </div>
                                <div class="metric-label">Trades/Min</div>
                            </div>
                        </div>
                    </div>

                    <!-- Features -->
                    <h6 class="text-uppercase text-muted mb-2">Key Features</h6>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-lightning fast-lane-accent me-2"></i>Sub-500ms execution</li>
                        <li><i class="bi bi-shield-check fast-lane-accent me-2"></i>MEV protection</li>
                        <li><i class="bi bi-graph-up fast-lane-accent me-2"></i>Mempool monitoring</li>
                        <li><i class="bi bi-speedometer2 fast-lane-accent me-2"></i>Gas optimization</li>
                    </ul>

                    <!-- Status Badge -->
                    <div class="mt-3">
                        {% if fast_lane_available %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>{{ fast_lane_metrics.status }}
                            </span>
                        {% else %}
                            <span class="badge bg-secondary">
                                <i class="bi bi-wrench me-1"></i>{{ fast_lane_metrics.status }}
                            </span>
                        {% endif %}
                        <span class="badge bg-primary ms-2 phase-badge">{{ fast_lane_metrics.phase }}</span>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <button class="btn btn-success btn-lg w-100" 
                            {% if not fast_lane_available %}disabled{% endif %}>
                        <i class="bi bi-lightning-charge me-2"></i>Choose Fast Lane
                    </button>
                </div>
            </div>
        </div>

        <!-- Smart Lane Mode -->
        <div class="col-lg-6">
            <div class="card card-glass mode-card smart-lane-card h-100 position-relative" 
                 {% if smart_lane_available %}onclick="selectMode('SMART_LANE')"{% endif %}>
                
                {% if not smart_lane_available %}
                <div class="disabled-overlay">
                    <div class="text-center text-white">
                        <i class="bi bi-gear display-4 mb-2"></i>
                        <div class="h5">Development Mode</div>
                        <small>Smart Lane available for testing</small>
                    </div>
                </div>
                {% endif %}
                
                <div class="card-header text-center">
                    <i class="bi bi-cpu smart-lane-accent fs-1 mb-2"></i>
                    <h3 class="smart-lane-accent mb-1">ðŸ§  Smart Lane</h3>
                    <p class="text-muted mb-0">Intelligence-Optimized Analysis</p>
                </div>
                <div class="card-body">
                    <!-- Performance Metrics -->
                    <div class="row mb-3">
                        <div class="col-4">
                            <div class="performance-metric">
                                <div class="metric-value smart-lane-accent">
                                    {{ smart_lane_metrics.execution_time_ms }}ms
                                </div>
                                <div class="metric-label">Analysis Time</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="performance-metric">
                                <div class="metric-value text-success">
                                    {{ smart_lane_metrics.success_rate }}%
                                </div>
                                <div class="metric-label">Success Rate</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="performance-metric">
                                <div class="metric-value text-warning">
                                    +{{ smart_lane_metrics.risk_adjusted_return }}%
                                </div>
                                <div class="metric-label">Risk-Adj Return</div>
                            </div>
                        </div>
                    </div>

                    <!-- Features -->
                    <h6 class="text-uppercase text-muted mb-2">Key Features</h6>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-brain smart-lane-accent me-2"></i>Comprehensive analysis</li>
                        <li><i class="bi bi-shield-check smart-lane-accent me-2"></i>AI-powered risk assessment</li>
                        <li><i class="bi bi-pie-chart smart-lane-accent me-2"></i>Strategic position sizing</li>
                        <li><i class="bi bi-lightbulb smart-lane-accent me-2"></i>AI thought logs</li>
                    </ul>

                    <!-- Status Badge -->
                    <div class="mt-3">
                        {% if smart_lane_available %}
                            <span class="badge bg-info">
                                <i class="bi bi-gear me-1"></i>{{ smart_lane_metrics.status }}
                            </span>
                        {% else %}
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-clock me-1"></i>{{ smart_lane_metrics.status }}
                            </span>
                        {% endif %}
                        <span class="badge bg-secondary ms-2 phase-badge">{{ smart_lane_metrics.phase }}</span>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <!-- Always enable Smart Lane button for Phase 5 testing -->
                    <button class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-cpu me-2"></i>Choose Smart Lane
                    </button>
                    {% if not smart_lane_available %}
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>Demo mode available
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison and Information -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card card-glass">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Mode Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fast-lane-accent">Fast Lane - For Speed</h6>
                            <ul class="list-unstyled small">
                                <li>â€¢ Sub-500ms execution times</li>
                                <li>â€¢ Perfect for sniping new launches</li>
                                <li>â€¢ MEV protection and private mempools</li>
                                <li>â€¢ Real-time mempool monitoring</li>
                                <li>â€¢ Gas optimization for minimum fees</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="smart-lane-accent">Smart Lane - For Intelligence</h6>
                            <ul class="list-unstyled small">
                                <li>â€¢ Comprehensive risk analysis</li>
                                <li>â€¢ AI-powered decision making</li>
                                <li>â€¢ Strategic position sizing</li>
                                <li>â€¢ Technical and social analysis</li>
                                <li>â€¢ Full transparency with thought logs</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-muted mb-3">
                            <strong class="comparison-highlight">Hybrid Approach:</strong> 
                            Switch between modes based on market conditions and opportunities
                        </p>
                        
                        <div class="d-flex gap-3 justify-content-center">
                            <button class="btn btn-outline-info btn-sm" onclick="showDemo('smart_lane')">
                                <i class="bi bi-play me-1"></i>View Smart Lane Demo
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="showHybridInfo()">
                                <i class="bi bi-shuffle me-1"></i>Learn Hybrid Strategy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4 mb-5">
        <div class="col-12 text-center">
            <a href="{% url 'dashboard:home' %}" class="btn btn-outline-light btn-lg me-3">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Hybrid Strategy Modal -->
<div class="modal fade" id="hybridModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-shuffle me-2"></i>Hybrid Trading Strategy
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fast-lane-accent">Use Fast Lane For:</h6>
                        <ul>
                            <li>New token launches and sniping</li>
                            <li>Arbitrage opportunities</li>
                            <li>Quick scalping trades</li>
                            <li>Time-sensitive market movements</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="smart-lane-accent">Use Smart Lane For:</h6>
                        <ul>
                            <li>Strategic portfolio positions</li>
                            <li>Risk-adjusted trading decisions</li>
                            <li>Complex market analysis</li>
                            <li>Long-term investment planning</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-lightbulb me-2"></i>Pro Tip</h6>
                    <p class="mb-0">Start with the mode that matches your immediate trading goal, then switch as market conditions change. Both engines can run simultaneously for maximum flexibility.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="selectMode('FAST_LANE')">
                    <i class="bi bi-lightning me-1"></i>Start with Fast Lane
                </button>
                <button type="button" class="btn btn-primary" onclick="selectMode('SMART_LANE')">
                    <i class="bi bi-cpu me-1"></i>Start with Smart Lane
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function selectMode(mode) {
    console.log('Selecting mode:', mode);
    
    // Find the clicked button and show loading state
    const cards = document.querySelectorAll('.mode-card');
    cards.forEach(card => {
        const button = card.querySelector('button');
        if (button && !button.disabled) {
            button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Setting up...';
            button.disabled = true;
        }
    });
    
    // Set trading mode and redirect to configuration
    setTradingMode(mode).then(() => {
        if (mode === 'SMART_LANE') {
            window.location.href = "{% url 'dashboard:configuration_panel' mode='smart_lane' %}";
        } else {
            window.location.href = "{% url 'dashboard:configuration_panel' mode='fast_lane' %}";
        }
    }).catch((error) => {
        console.error('Failed to set trading mode:', error);

        // Restore button states
        cards.forEach(card => {
            const button = card.querySelector('button');
            if (button) {
                if (mode === 'SMART_LANE') {
                    button.innerHTML = '<i class="bi bi-cpu me-2"></i>Choose Smart Lane';
                } else {
                    button.innerHTML = '<i class="bi bi-lightning-charge me-2"></i>Choose Fast Lane';
                }
                button.disabled = false;
            }
        });

        alert('Failed to set trading mode. Please try again.');
    });
}

function showDemo(mode) {
    if (mode === 'smart_lane') {
        window.location.href = "{% url 'dashboard:smart_lane_demo' %}";
    }
}

function showHybridInfo() {
    const modal = new bootstrap.Modal(document.getElementById('hybridModal'));
    modal.show();
}

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function setTradingMode(mode) {
    return fetch('{% url "dashboard:api_set_trading_mode" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ mode: mode })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to set trading mode');
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Unknown error');
        }
        return data;
    });
}

// Initialize page functionality
document.addEventListener('DOMContentLoaded', function() {
    const modeCards = document.querySelectorAll('.mode-card');
    
    modeCards.forEach(card => {
        const disabledOverlay = card.querySelector('.disabled-overlay');
        if (disabledOverlay) return;
        
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    modeCards.forEach(card => {
        const disabledOverlay = card.querySelector('.disabled-overlay');
        if (disabledOverlay) return;
        
        card.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') return;
            
            if (this.classList.contains('fast-lane-card')) {
                selectMode('FAST_LANE');
            } else if (this.classList.contains('smart-lane-card')) {
                selectMode('SMART_LANE');
            }
        });
    });
    
    setTimeout(() => {
        const metrics = document.querySelectorAll('.metric-value');
        metrics.forEach(metric => {
            metric.style.opacity = '0';
            metric.style.transform = 'translateY(20px)';
            metric.style.transition = 'all 0.6s ease';
            
            setTimeout(() => {
                metric.style.opacity = '1';
                metric.style.transform = 'translateY(0)';
            }, Math.random() * 300);
        });
    }, 200);
});
</script>
{% endblock %}
