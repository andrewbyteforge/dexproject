{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics - DEX Trading Bot{% endblock %}

{% block extra_css %}
<style>
/* Portfolio Cards */
.portfolio-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 212, 170, 0.2);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.portfolio-card:hover {
    border-color: rgba(0, 212, 170, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 212, 170, 0.1);
}

.pnl-positive { color: #00d4aa; }
.pnl-negative { color: #ff6b6b; }
.pnl-neutral { color: #74b9ff; }

.trade-row {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 8px;
    border-left: 3px solid transparent;
    transition: all 0.3s ease;
}

.trade-row:hover {
    background: rgba(255, 255, 255, 0.08);
}

.trade-buy { border-left-color: #00d4aa; }
.trade-sell { border-left-color: #ff6b6b; }

.position-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
}

.metric-large {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(45deg, #00d4aa, #00b894);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.metric-medium {
    font-size: 1.5rem;
    font-weight: 600;
}

.trading-controls {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-trade {
    background: linear-gradient(45deg, #00d4aa, #00b894);
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.btn-trade:hover {
    background: linear-gradient(45deg, #00b894, #00a085);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
}

.btn-trade.btn-sell {
    background: linear-gradient(45deg, #ff6b6b, #e55555);
}

.btn-trade.btn-sell:hover {
    background: linear-gradient(45deg, #e55555, #cc4444);
}

.no-data-placeholder {
    text-align: center;
    padding: 40px 20px;
    color: #999;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid main-content">
    <div class="row">
        <!-- Main Content Area -->
        <div class="col-md-10 offset-md-2 p-4">
            
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 mb-2">
                                <i class="bi bi-graph-up fast-lane-accent me-2"></i>
                                Trading Analytics
                            </h1>
                            <p class="text-muted mb-0">Real-time performance metrics and portfolio insights</p>
                        </div>
                        <div>
                            {% if performance_metrics.data_source == 'LIVE' %}
                                <span class="badge bg-success">
                                    <i class="bi bi-broadcast me-1"></i>Live Data
                                </span>
                            {% else %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-cpu me-1"></i>Demo Mode
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Summary Cards -->
            {% if analytics_ready %}
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card portfolio-card">
                        <div class="card-body text-center">
                            <i class="bi bi-wallet2 fast-lane-accent fs-1 mb-3"></i>
                            <div class="metric-large mb-1">
                                ${{ portfolio_data.total_value_usd|floatformat:2 }}
                            </div>
                            <small class="text-muted">Portfolio Value</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card portfolio-card">
                        <div class="card-body text-center">
                            <i class="bi bi-graph-up-arrow {% if portfolio_data.total_pnl_usd >= 0 %}text-success{% else %}text-danger{% endif %} fs-1 mb-3"></i>
                            <div class="metric-large mb-1 {% if portfolio_data.total_pnl_usd >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
                                ${{ portfolio_data.total_pnl_usd|floatformat:2 }}
                            </div>
                            <small class="text-muted">Total P&L</small>
                            <div class="small {% if portfolio_data.total_roi_percent >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
                                ({{ portfolio_data.total_roi_percent|floatformat:1 }}%)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card portfolio-card">
                        <div class="card-body text-center">
                            <i class="bi bi-layers fast-lane-accent fs-1 mb-3"></i>
                            <div class="metric-large mb-1">
                                {{ portfolio_data.position_count }}
                            </div>
                            <small class="text-muted">Active Positions</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card portfolio-card">
                        <div class="card-body text-center">
                            <i class="bi bi-award text-warning fs-1 mb-3"></i>
                            <div class="metric-large mb-1">
                                {{ performance_analytics.win_rate_percent|floatformat:1 }}%
                            </div>
                            <small class="text-muted">Win Rate</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Main Analytics Content -->
            <div class="row mb-4">
                <!-- Portfolio Breakdown -->
                <div class="col-lg-8 mb-4">
                    {% if has_portfolio_data %}
                    <div class="card card-glass">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-pie-chart me-2"></i>
                                Portfolio Breakdown
                            </h5>
                            <small class="text-muted">{{ portfolio_data.position_count }} positions</small>
                        </div>
                        <div class="card-body">
                            {% for position in portfolio_data.positions %}
                            <div class="position-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ position.symbol }}</strong>
                                        <div class="small text-muted">
                                            Invested: ${{ position.invested|floatformat:2 }} â€¢ 
                                            {{ position.opened_days }} days ago
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="metric-medium">
                                            ${{ position.current_value|floatformat:2 }}
                                        </div>
                                        <div class="small {% if position.pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
                                            ${{ position.pnl|floatformat:2 }} ({{ position.roi_percent|floatformat:1 }}%)
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="card card-glass">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-pie-chart me-2"></i>
                                Portfolio Breakdown
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="no-data-placeholder">
                                <i class="bi bi-briefcase display-1 text-muted mb-3"></i>
                                <h5 class="text-muted">No Active Positions</h5>
                                <p class="text-muted">Start trading to see your portfolio breakdown here.</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- P&L Chart and Risk Metrics -->
                <div class="col-lg-4 mb-4">
                    <div class="card card-glass mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-graph-up me-2"></i>
                                P&L Overview
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if analytics_ready %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Realized P&L:</span>
                                    <span class="{% if pnl_metrics.total_realized_pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
                                        ${{ pnl_metrics.total_realized_pnl|floatformat:2 }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Unrealized P&L:</span>
                                    <span class="{% if pnl_metrics.total_unrealized_pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
                                        ${{ pnl_metrics.total_unrealized_pnl|floatformat:2 }}
                                    </span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total P&L:</strong>
                                    <strong class="{% if pnl_metrics.total_pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
                                        ${{ pnl_metrics.total_pnl|floatformat:2 }}
                                    </strong>
                                </div>
                            </div>
                            
                            <!-- Mini P&L Chart -->
                            <div class="chart-container" style="height: 150px;">
                                <canvas id="pnlChart"></canvas>
                            </div>
                            {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-graph-up display-4 mb-2"></i>
                                <p>P&L data will appear after trading activity</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Risk Metrics -->
                    <div class="card card-glass">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-shield-check me-2"></i>
                                Risk Metrics
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Avg Risk Score:</span>
                                    <span class="{% if risk_metrics.avg_risk_score < 30 %}text-success{% elif risk_metrics.avg_risk_score < 70 %}text-warning{% else %}text-danger{% endif %}">
                                        {{ risk_metrics.avg_risk_score|floatformat:1 }}/100
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Assessments (7d):</span>
                                    <span>{{ risk_metrics.total_assessments_7d }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Blocked Tokens:</span>
                                    <span class="text-danger">{{ risk_metrics.blocked_tokens }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Approved Tokens:</span>
                                    <span class="text-success">{{ risk_metrics.approved_tokens }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Trading Activity -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="card card-glass">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-clock-history me-2"></i>
                                Recent Trading Activity
                            </h5>
                            <small class="text-muted">Last {{ trading_activity.recent_trades|length }} trades</small>
                        </div>
                        <div class="card-body">
                            {% if has_trading_data %}
                            {% for trade in trading_activity.recent_trades %}
                            <div class="trade-row trade-{{ trade.type|lower }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-{% if trade.type == 'BUY' %}success{% else %}danger{% endif %} me-2">
                                                {{ trade.type }}
                                            </span>
                                            <strong>{{ trade.symbol }}</strong>
                                        </div>
                                        <div class="small text-muted">
                                            {{ trade.timestamp|date:"M d, H:i" }}
                                            {% if trade.transaction_hash %}
                                            â€¢ <code>{{ trade.transaction_hash }}</code>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div>${{ trade.amount|floatformat:4 }}</div>
                                        <div class="small">
                                            <span class="badge bg-{% if trade.status == 'CONFIRMED' %}success{% elif trade.status == 'PENDING' %}warning{% else %}secondary{% endif %}">
                                                {{ trade.status }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="no-data-placeholder">
                                <i class="bi bi-clock-history display-1 text-muted mb-3"></i>
                                <h5 class="text-muted">No Trading Activity</h5>
                                <p class="text-muted">Your recent trades will appear here once you start trading.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Performance Metrics & Controls -->
                <div class="col-lg-4 mb-4">
                    <div class="card card-glass mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Performance Metrics
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Total Trades:</span>
                                    <span>{{ performance_analytics.total_trades }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Success Rate:</span>
                                    <span class="text-success">{{ performance_analytics.win_rate_percent|floatformat:1 }}%</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Avg Trade Size:</span>
                                    <span>${{ performance_analytics.avg_trade_size_usd|floatformat:2 }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Total Volume:</span>
                                    <span>${{ performance_analytics.total_volume_usd|floatformat:0 }}</span>
                                </div>
                                {% if performance_analytics.sharpe_ratio %}
                                <div class="d-flex justify-content-between">
                                    <span>Sharpe Ratio:</span>
                                    <span>{{ performance_analytics.sharpe_ratio|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Trading Controls -->
                    {% if wallet_info.connected %}
                    <div class="trading-controls">
                        <h6 class="mb-3">
                            <i class="bi bi-lightning-charge me-2"></i>
                            Quick Actions
                        </h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-trade" onclick="triggerSmartAnalysis()">
                                <i class="bi bi-brain me-2"></i>Smart Analysis
                            </button>
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn btn-trade w-100" onclick="showTradeModal('buy')">
                                        <i class="bi bi-plus-circle me-1"></i>Buy
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-trade btn-sell w-100" onclick="showTradeModal('sell')">
                                        <i class="bi bi-dash-circle me-1"></i>Sell
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="trading-controls text-center">
                        <i class="bi bi-wallet2 display-4 text-muted mb-3"></i>
                        <h6 class="text-muted">Connect Wallet</h6>
                        <p class="small text-muted mb-3">Connect your wallet to enable trading controls</p>
                        <button class="btn btn-trade" onclick="connectWallet()">
                            <i class="bi bi-wallet2 me-2"></i>Connect Wallet
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12 text-center">
                    <a href="{% url 'dashboard:home' %}" class="btn btn-outline-light me-3">
                        <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    <button class="btn btn-fast-lane" onclick="refreshAnalytics()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Manual Trading Modal -->
<div class="modal fade" id="tradeModal" tabindex="-1" aria-labelledby="tradeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="tradeModalLabel">Manual Trade</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="tradeForm">
                    <div class="mb-3">
                        <label for="tokenAddress" class="form-label">Token Address</label>
                        <input type="text" class="form-control bg-secondary text-white" id="tokenAddress" placeholder="0x..." required>
                    </div>
                    <div class="mb-3">
                        <label for="pairAddress" class="form-label">Pair Address</label>
                        <input type="text" class="form-control bg-secondary text-white" id="pairAddress" placeholder="0x..." required>
                    </div>
                    <div class="mb-3">
                        <label for="tradeAmount" class="form-label">Amount</label>
                        <div class="input-group">
                            <input type="number" class="form-control bg-secondary text-white" id="tradeAmount" step="0.001" min="0.001" required>
                            <span class="input-group-text bg-secondary text-white" id="amountUnit">ETH</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="slippageTolerance" class="form-label">Slippage Tolerance (%)</label>
                        <input type="number" class="form-control bg-secondary text-white" id="slippageTolerance" value="5" min="0.1" max="20" step="0.1">
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Risk Warning:</strong> This trade will undergo risk assessment before execution.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-trade" id="executeTradeBtn">Execute Trade</button>
            </div>
        </div>
    </div>
</div>

<style>
.border-dashed {
    border: 2px dashed rgba(0, 212, 170, 0.3) !important;
}

.metric-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
}

.card-glass {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-outline-light:hover {
    color: #000;
}

.btn-fast-lane {
    background: linear-gradient(45deg, #00d4aa, #00b894);
    border: none;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-fast-lane:hover {
    background: linear-gradient(45deg, #00b894, #00a085);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 212, 170, 0.3);
}
</style>

<script>
// Global variables
let currentTradeAction = 'buy';

// Page initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('Analytics page loaded');
    
    // Initialize P&L chart if data is available
    {% if analytics_ready and pnl_metrics.daily_pnl %}
    initializePnLChart();
    {% endif %}
    
    // Auto-refresh data every 30 seconds
    setInterval(refreshAnalytics, 30000);
});

// Initialize P&L Chart
function initializePnLChart() {
    const ctx = document.getElementById('pnlChart');
    if (!ctx) return;
    
    const chartData = {{ chart_data.pnl_timeline|safe }};
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [{
                label: 'P&L',
                data: chartData.map(d => d.pnl),
                borderColor: '#00d4aa',
                backgroundColor: 'rgba(0, 212, 170, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    display: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#999',
                        callback: function(value) {
                            return ' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}

// Refresh analytics data
async function refreshAnalytics() {
    console.log('Refreshing analytics data...');
    
    try {
        // Show loading indicator
        showToast('Refreshing analytics data...', 'info');
        
        // Refresh the page to get latest data
        // In a real implementation, this would use AJAX to update specific sections
        window.location.reload();
        
    } catch (error) {
        console.error('Failed to refresh analytics:', error);
        showToast('Failed to refresh analytics data', 'error');
    }
}

// Show trading modal
function showTradeModal(action) {
    currentTradeAction = action;
    
    // Update modal title and button text
    const modalTitle = document.getElementById('tradeModalLabel');
    const executeBtn = document.getElementById('executeTradeBtn');
    const amountUnit = document.getElementById('amountUnit');
    
    if (action === 'buy') {
        modalTitle.textContent = 'Manual Buy Order';
        executeBtn.textContent = 'Execute Buy';
        executeBtn.className = 'btn btn-trade';
        amountUnit.textContent = 'ETH';
    } else {
        modalTitle.textContent = 'Manual Sell Order';
        executeBtn.textContent = 'Execute Sell';
        executeBtn.className = 'btn btn-trade btn-sell';
        amountUnit.textContent = 'Tokens';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('tradeModal'));
    modal.show();
}

// Execute manual trade
document.getElementById('executeTradeBtn')?.addEventListener('click', async function() {
    const tokenAddress = document.getElementById('tokenAddress').value;
    const pairAddress = document.getElementById('pairAddress').value;
    const amount = document.getElementById('tradeAmount').value;
    const slippage = document.getElementById('slippageTolerance').value;
    
    // Validate inputs
    if (!tokenAddress || !pairAddress || !amount) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    if (!tokenAddress.startsWith('0x') || !pairAddress.startsWith('0x')) {
        showToast('Please enter valid contract addresses', 'error');
        return;
    }
    
    // Show loading state
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
    
    try {
        // Call the manual trade API
        const response = await fetch('/dashboard/api/trading/manual/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                action: currentTradeAction,
                token_address: tokenAddress,
                pair_address: pairAddress,
                amount: parseFloat(amount),
                slippage_tolerance: parseFloat(slippage) / 100
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showToast(`${currentTradeAction.toUpperCase()} order submitted successfully!`, 'success');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('tradeModal')).hide();
            
            // Reset form
            document.getElementById('tradeForm').reset();
            
            // Refresh data after a short delay
            setTimeout(refreshAnalytics, 2000);
            
        } else {
            showToast(`Failed to submit order: ${result.error}`, 'error');
        }
        
    } catch (error) {
        console.error('Trade execution error:', error);
        showToast('Failed to execute trade. Please try again.', 'error');
    } finally {
        // Restore button state
        this.disabled = false;
        this.innerHTML = currentTradeAction === 'buy' ? 'Execute Buy' : 'Execute Sell';
    }
});

// Trigger Smart Lane analysis
async function triggerSmartAnalysis() {
    const tokenAddress = prompt('Enter token address for Smart Lane analysis:');
    const pairAddress = prompt('Enter pair address:');
    
    if (!tokenAddress || !pairAddress) {
        showToast('Token and pair addresses are required', 'warning');
        return;
    }
    
    if (!tokenAddress.startsWith('0x') || !pairAddress.startsWith('0x')) {
        showToast('Please enter valid contract addresses', 'error');
        return;
    }
    
    try {
        showToast('Triggering Smart Lane analysis...', 'info');
        
        const response = await fetch('/dashboard/api/trading/smart-lane/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                token_address: tokenAddress,
                pair_address: pairAddress
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showToast('Smart Lane analysis initiated! Check back in a few minutes.', 'success');
        } else {
            showToast(`Failed to trigger analysis: ${result.error}`, 'error');
        }
        
    } catch (error) {
        console.error('Smart analysis error:', error);
        showToast('Failed to trigger Smart Lane analysis', 'error');
    }
}

// Connect wallet function
function connectWallet() {
    if (window.walletManager && window.walletManager.connectWallet) {
        window.walletManager.connectWallet();
    } else {
        showToast('Wallet connection not available. Please check your setup.', 'warning');
    }
}

// Utility functions
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Add to page
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Real-time updates (if SSE is available)
function startRealTimeUpdates() {
    if (typeof EventSource !== 'undefined') {
        const eventSource = new EventSource('/dashboard/metrics/stream/');
        
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                
                // Update portfolio summary if available
                if (data.portfolio_summary) {
                    updatePortfolioSummary(data.portfolio_summary);
                }
                
            } catch (error) {
                console.error('Error processing real-time update:', error);
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('EventSource failed:', error);
            eventSource.close();
        };
        
        // Close connection when page unloads
        window.addEventListener('beforeunload', function() {
            eventSource.close();
        });
    }
}

function updatePortfolioSummary(summary) {
    // Update portfolio value cards with real-time data
    // This would update specific elements with new values
    console.log('Portfolio update received:', summary);
}

// Start real-time updates if available
{% if analytics_ready %}
setTimeout(startRealTimeUpdates, 1000);
{% endif %}
</script>
{% endblock %}