{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - DEX Auto-Trading Bot{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid main-content">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-2">
                        <i class="bi bi-speedometer2 me-2"></i>
                        Trading Dashboard
                    </h1>
                    <p class="text-muted mb-0">Real-time DEX trading automation and analytics</p>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-3">
                        <i class="bi bi-broadcast me-1"></i>
                        <span id="data-source-text">{{ data_source|default:"DEMO MODE" }}</span>
                    </span>
                    <div class="d-flex align-items-center">
                        <span class="me-2 small">System:</span>
                        <span class="status-indicator" id="system-status-indicator"></span>
                        <span class="small" id="system-status-text">{{ system_status|default:"Initializing" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Row -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card card-glass metric-card">
                <div class="card-body text-center">
                    <i class="bi bi-lightning-charge-fill fast-lane-accent fs-1 mb-3"></i>
                    <h3 class="card-title mb-1" id="fast-lane-tokens-analyzed">{{ metrics.fast_lane.tokens_analyzed_today|default:0 }}</h3>
                    <p class="text-muted mb-2">Fast Lane Tokens</p>
                    <div class="small">
                        <span class="fast-lane-accent" id="fast-lane-success-rate">{{ metrics.fast_lane.success_rate|default:0|floatformat:1 }}%</span>
                        success rate
                    </div>
                    <div class="small text-muted">
                        Avg: <span id="fast-lane-avg-time">{{ metrics.fast_lane.avg_execution_time_ms|default:0|floatformat:1 }}</span>ms
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card card-glass metric-card">
                <div class="card-body text-center">
                    <i class="bi bi-cpu-fill smart-lane-accent fs-1 mb-3"></i>
                    <h3 class="card-title mb-1" id="smart-lane-analyses">{{ metrics.smart_lane.detailed_analyses_today|default:0 }}</h3>
                    <p class="text-muted mb-2">Smart Lane Analyses</p>
                    <div class="small">
                        <span class="smart-lane-accent" id="smart-lane-success-rate">{{ metrics.smart_lane.success_rate|default:0|floatformat:1 }}%</span>
                        confidence rate
                    </div>
                    <div class="small text-muted">
                        Avg: <span id="smart-lane-avg-time">{{ metrics.smart_lane.avg_analysis_time_ms|default:0|floatformat:1 }}</span>ms
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card card-glass metric-card">
                <div class="card-body text-center">
                    <i class="bi bi-currency-dollar text-success fs-1 mb-3"></i>
                    <h3 class="card-title mb-1" id="total-volume">${{ metrics.system.total_volume_24h|default:0|floatformat:2 }}</h3>
                    <p class="text-muted mb-2">24h Volume</p>
                    <div class="small">
                        <span class="text-info" id="active-positions">{{ metrics.system.active_positions|default:0 }}</span>
                        active positions
                    </div>
                    <div class="small text-muted">
                        P&L: <span id="profit-loss" class="{% if metrics.system.profit_loss_24h >= 0 %}text-success{% else %}text-danger{% endif %}">${{ metrics.system.profit_loss_24h|default:0|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card card-glass metric-card">
                <div class="card-body text-center">
                    <i class="bi bi-shield-check text-info fs-1 mb-3"></i>
                    <h3 class="card-title mb-1">System Health</h3>
                    <p class="text-muted mb-2">All Components</p>
                    <div class="d-flex justify-content-center align-items-center mb-2">
                        <div class="me-3">
                            <span class="status-indicator" id="engine-health"></span>
                            <small>Engine</small>
                        </div>
                        <div class="me-3">
                            <span class="status-indicator" id="blockchain-health"></span>
                            <small>Chain</small>
                        </div>
                        <div>
                            <span class="status-indicator" id="data-health"></span>
                            <small>Data</small>
                        </div>
                    </div>
                    <div class="small text-muted">Last check: {{ health_check_time|default:"Now" }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Chart Row -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-3">
            <div class="card card-glass">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Performance Metrics
                    </h5>
                    <small class="text-muted" id="chart-last-update">Live</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-3">
            <div class="card card-glass">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-brain me-2"></i>
                        Smart Lane Thought Log
                    </h5>
                    <button class="btn btn-sm btn-outline-light" onclick="exportThoughtLog()">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="thought-log-container" id="thought-log-container">
                        {% for entry in thought_log_entries %}
                        <div class="thought-log-step">
                            <span class="text-muted">[{{ entry.timestamp|time:"H:i:s" }}]</span> 
                            {{ entry.text }}
                            {% if entry.confidence %}
                            <span class="analysis-badge {% if entry.confidence >= 80 %}high-confidence{% elif entry.confidence >= 60 %}medium-confidence{% else %}low-confidence{% endif %}">
                                {{ entry.confidence }}%
                            </span>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="thought-log-step text-muted">
                            <i class="bi bi-hourglass-split me-2"></i>
                            Waiting for Smart Lane analysis...
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel Row -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="card card-glass">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning-charge fast-lane-accent me-2"></i>
                        Fast Lane Control
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Rapid token detection and automatic trading execution</p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong class="fast-lane-accent">Status:</strong>
                            <span class="ms-2">{% if fast_lane_active %}Active{% else %}Inactive{% endif %}</span>
                        </div>
                        <button class="btn btn-fast-lane" id="fast-lane-toggle-btn">
                            <i class="bi bi-{% if fast_lane_active %}pause{% else %}play{% endif %}-fill me-2"></i>
                            {% if fast_lane_active %}Pause{% else %}Start{% endif %} Fast Lane
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-primary w-100" onclick="runQuickAnalysis()">
                                <i class="bi bi-search me-2"></i>
                                Quick Analysis
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <a href="{% url 'dashboard:configuration_panel' mode='fast_lane' %}" class="btn btn-outline-warning w-100">
                                <i class="bi bi-gear me-2"></i>
                                Settings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-3">
            <div class="card card-glass">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-cpu smart-lane-accent me-2"></i>
                        Smart Lane Control
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Advanced AI analysis and strategic decision making</p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong class="smart-lane-accent">Status:</strong>
                            <span class="ms-2">{% if smart_lane_active %}Active{% else %}Inactive{% endif %}</span>
                        </div>
                        <button class="btn btn-smart-lane" id="smart-lane-toggle-btn">
                            <i class="bi bi-{% if smart_lane_active %}pause{% else %}play{% endif %}-fill me-2"></i>
                            {% if smart_lane_active %}Pause{% else %}Start{% endif %} Smart Lane
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-success w-100" onclick="enableHybridMode()">
                                <i class="bi bi-shuffle me-2"></i>
                                Hybrid Mode
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button class="btn btn-outline-info w-100" onclick="viewAnalytics()">
                                <i class="bi bi-graph-up me-2"></i>
                                Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Integration Section -->
    {% if user.is_authenticated %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-glass">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-wallet2 me-2"></i>
                        Wallet Connection
                    </h5>
                    <span class="badge bg-info">DEX Integration</span>
                </div>
                <div class="card-body">
                    <!-- Wallet not connected state -->
                    <div id="wallet-connect-btn" class="text-center" style="display: block;">
                        <p class="text-muted mb-3">Connect your wallet to enable live trading</p>
                        <button class="btn btn-fast-lane" onclick="window.walletManager?.showWalletModal()">
                            <i class="bi bi-wallet-fill me-2"></i>
                            Connect Wallet
                        </button>
                    </div>
                    
                    <!-- Wallet connected state -->
                    <div id="wallet-display" class="wallet-display" style="display: none;">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <strong>Address:</strong>
                                <div class="font-monospace" id="wallet-display-address">Not Connected</div>
                            </div>
                            <div class="col-md-4">
                                <strong>Network:</strong>
                                <div>
                                    <span class="badge bg-secondary" id="wallet-display-chain">Not Connected</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <strong>Balance:</strong>
                                <div class="wallet-balance-display" id="wallet-display-balance">0.00 ETH</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% comment %} <!-- Quick Actions Row -->
    <div class="row">
        <div class="col-12">
            <div class="card card-glass">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-outline-primary w-100" onclick="runQuickAnalysis()">
                                <i class="bi bi-search me-2"></i>
                                Quick Analysis
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-outline-success w-100" onclick="enableHybridMode()">
                                <i class="bi bi-shuffle me-2"></i>
                                Hybrid Mode
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{% url 'dashboard:configuration_panel' mode='fast_lane' %}" class="btn btn-outline-warning w-100">
                                <i class="bi bi-gear me-2"></i>
                                Settings
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-outline-info w-100" onclick="viewAnalytics()">
                                <i class="bi bi-graph-up me-2"></i>
                                Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> {% endcomment %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js for performance charts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<!-- Dashboard Configuration (Django template variables) -->
<script>
window.dashboardConfig = {
    metricsStreamUrl: '{% url "dashboard:metrics_stream" %}',
    analyticsUrl: '{% url "dashboard:analytics" %}',
    fastLaneActive: {{ fast_lane_active|yesno:"true,false" }},
    smartLaneActive: {{ smart_lane_active|yesno:"true,false" }},
    dataSource: '{{ data_source|default:"DEMO" }}'
};
</script>

<!-- Main Dashboard JavaScript -->
<script src="{% static 'js/home.js' %}"></script>
{% endblock %}