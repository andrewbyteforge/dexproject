# üìã **PHASE 7B: ADVANCED STRATEGIES - DETAILED PROGRESS TRACKER**

## üéØ **Phase Overview**

**Goal:** Implement institutional-grade trading strategies with backtesting capabilities  
**Timeline:** 2 weeks (14 days)  
**Estimated Code:** ~3,200 lines  
**Priority:** HIGH - Competitive differentiators

### **üö® CRITICAL ARCHITECTURAL DECISION (Nov 11, 2025):**

**Strategy Architecture: AUTOMATED (Option A)** ‚úÖ

Strategies are **NOT manual placement tools**. Instead, they are **intelligent tactics** that the bot can automatically deploy based on market conditions.

**How It Works:**
1. Bot scans tokens automatically (existing behavior)
2. Bot analyzes market conditions (liquidity, volatility, trend)
3. **NEW:** Bot selects optimal entry strategy:
   - High volatility + range-bound ‚Üí **Grid Strategy**
   - Strong trend + large position ‚Üí **DCA Strategy**
   - Clear signal + good liquidity ‚Üí **Spot Buy** (existing)
4. Bot executes and manages strategy lifecycle
5. User configures strategy preferences (not individual trades)

**User Experience:**
- Set Intel Level (1-10) for risk tolerance
- Enable/disable strategy types (DCA, Grid, TWAP, VWAP)
- Configure strategy parameters (intervals, grid levels, etc.)
- **Bot decides when and how to use each strategy**

**Competitive Advantage:**
"Our bot doesn't just buy tokens - it deploys institutional strategies intelligently"

---

### **What We're Building:**

1. **Dollar Cost Averaging (DCA)** - Bot-selected automated recurring buys
2. **Grid Trading Bot** - Bot-deployed profit from price oscillations
3. **TWAP Execution** - Bot-managed time-weighted order splitting ‚≠ê
4. **VWAP Execution** - Bot-optimized volume-weighted timing ‚≠ê
5. **Custom Strategy Builder** - User-defined rules for bot ‚≠ê
6. **Strategy Backtesting** - Prove profitability before risking funds ‚≠ê‚≠ê‚≠ê

**Competitive Advantages After Phase 7B:**
- ‚úÖ All Unibot/Maestro features
- ‚≠ê‚≠ê Bot intelligently selects strategy based on market conditions (UNIQUE)
- ‚≠ê‚≠ê‚≠ê Backtesting proves profitability risk-free (MASSIVE differentiator)

---

## üìÖ **Two-Week Schedule (UPDATED)**

### **Week 1: Foundation & Bot Integration**
- **Day 1:** ‚úÖ Strategy framework & models - **COMPLETE**
- **Day 2:** ‚úÖ DCA strategy implementation - **COMPLETE**
- **Day 3:** ‚úÖ Grid trading strategy - **COMPLETE**
- **Day 4:** ‚úÖ Strategy executor service - **COMPLETE**
- **Day 5:** üîÑ **Bot Integration & Strategy Selection Logic** - **NEXT** ‚≠ê‚≠ê‚≠ê
- **Day 6-7:** Bot Configuration UI (strategy preferences)
- **Day 8:** Week 1 testing & documentation

### **Week 2: Advanced Strategies & Backtesting**
- **Day 9:** TWAP strategy implementation
- **Day 10:** VWAP strategy implementation
- **Day 11:** Custom strategy builder
- **Day 12:** Backtesting engine (core)
- **Day 13:** Backtesting UI & reports
- **Day 14:** Integration testing & polish
- **Day 15:** Final testing & documentation

---

## ‚úÖ **Days 1-4: Foundation - COMPLETE**

[Previous Days 1-4 content remains the same - not repeating here for brevity]

**Summary:**
- ‚úÖ Strategy framework & models complete
- ‚úÖ DCA strategy operational
- ‚úÖ Grid strategy operational
- ‚úÖ Strategy executor service tested
- ‚úÖ ~3,011 lines of production code
- ‚úÖ Full Celery integration
- ‚úÖ WebSocket notifications working

---

## üîÑ **Day 5: Bot Integration & Strategy Selection Logic - NEXT**

**Status:** üîÑ In Progress (0%)  
**Estimated Time:** ~4-6 hours  
**Priority:** CRITICAL ‚≠ê‚≠ê‚≠ê

### **Goal:**
Refactor `market_analyzer.py` to integrate strategy selection into the bot's automated decision-making process. The bot should intelligently choose between Spot Buy, DCA, or Grid strategies based on market conditions.

---

### **Files to Modify:**

#### 1. **`paper_trading/bot/market_analyzer.py`** - MAJOR REFACTOR (~400 lines modified)

**Current Flow:**
```python
# Existing: Bot only does spot buys
def _analyze_token(token):
    decision = intelligence_engine.analyze(token)
    if decision.action == "BUY":
        trade_executor.execute_trade(decision)  # Always spot buy
```

**New Flow:**
```python
# New: Bot selects strategy based on market conditions
def _analyze_token(token):
    decision = intelligence_engine.analyze(token)
    
    if decision.action == "BUY":
        # NEW: Select best strategy for this opportunity
        strategy_type = self._select_strategy(token, decision)
        
        if strategy_type == StrategyType.SPOT:
            # Existing spot buy logic
            trade_executor.execute_trade(decision)
        
        elif strategy_type == StrategyType.DCA:
            # NEW: Start DCA strategy
            self._start_dca_strategy(token, decision)
        
        elif strategy_type == StrategyType.GRID:
            # NEW: Start Grid strategy
            self._start_grid_strategy(token, decision)
```

**New Methods to Add:**

##### **`_select_strategy(token, decision) -> StrategyType`**
Analyzes market conditions and returns the optimal strategy:

```python
def _select_strategy(self, token_address: str, decision: TradingDecision) -> str:
    """
    Select optimal trading strategy based on market conditions.
    
    Decision Matrix:
    - High volatility + range-bound ‚Üí Grid Strategy
    - Strong trend + large position ‚Üí DCA Strategy
    - Clear signal + good liquidity ‚Üí Spot Buy
    
    Returns:
        StrategyType constant (SPOT, DCA, or GRID)
    """
    # Get market context
    context = decision.market_context
    
    # Strategy preferences from config
    strategy_prefs = self.strategy_config.strategy_preferences
    
    # Decision logic:
    
    # 1. Check if Grid is appropriate
    if (strategy_prefs.get('enable_grid', False) and
        context.volatility > 0.05 and  # >5% volatility
        context.trend == 'sideways' and
        context.liquidity > 100000):  # Good liquidity
        
        logger.info(f"Selected GRID strategy: volatility={context.volatility}, trend={context.trend}")
        return StrategyType.GRID
    
    # 2. Check if DCA is appropriate
    if (strategy_prefs.get('enable_dca', False) and
        context.trend in ['uptrend', 'strong_uptrend'] and
        decision.confidence_percent > 70 and
        decision.position_size_usd > strategy_prefs.get('dca_min_amount', 100)):
        
        logger.info(f"Selected DCA strategy: trend={context.trend}, confidence={decision.confidence_percent}%")
        return StrategyType.DCA
    
    # 3. Default to spot buy
    logger.info("Selected SPOT buy: standard conditions")
    return StrategyType.SPOT
```

##### **`_start_dca_strategy(token, decision)`**
Configures and starts a DCA strategy:

```python
def _start_dca_strategy(self, token_address: str, decision: TradingDecision) -> None:
    """
    Start a DCA strategy for this token based on market conditions.
    
    Args:
        token_address: Token to DCA into
        decision: Trading decision from intelligence engine
    """
    from paper_trading.services import get_strategy_executor
    
    # Get DCA preferences from config
    dca_prefs = self.strategy_config.strategy_preferences.get('dca', {})
    
    # Calculate DCA parameters based on position size and market conditions
    total_amount = float(decision.position_size_usd)
    num_intervals = dca_prefs.get('num_intervals', 5)  # Default 5 buys
    interval_hours = dca_prefs.get('interval_hours', 2)  # Every 2 hours
    
    # Start the strategy
    executor = get_strategy_executor()
    
    try:
        strategy_run = executor.start_strategy(
            account=self.account,
            strategy_type=StrategyType.DCA,
            config={
                'total_amount_usd': str(total_amount),
                'num_intervals': num_intervals,
                'interval_hours': interval_hours,
                'token_address': token_address,
                'token_symbol': decision.token_symbol,
            }
        )
        
        logger.info(
            f"Started DCA strategy {strategy_run.strategy_id}: "
            f"{num_intervals} buys of ${total_amount/num_intervals:.2f} every {interval_hours}h"
        )
        
        # Log AI thought
        self._log_thought(
            decision_type='DCA_STRATEGY',
            confidence=decision.confidence_percent,
            reasoning=f"Bot selected DCA: Strong {decision.market_context.trend} trend, spreading ${total_amount} over {num_intervals} intervals"
        )
        
    except Exception as e:
        logger.error(f"Failed to start DCA strategy: {e}")
        # Fallback to spot buy
        self.trade_executor.execute_trade(decision)
```

##### **`_start_grid_strategy(token, decision)`**
Configures and starts a Grid strategy:

```python
def _start_grid_strategy(self, token_address: str, decision: TradingDecision) -> None:
    """
    Start a Grid strategy for this token based on market conditions.
    
    Args:
        token_address: Token to setup grid for
        decision: Trading decision from intelligence engine
    """
    from paper_trading.services import get_strategy_executor
    
    # Get Grid preferences from config
    grid_prefs = self.strategy_config.strategy_preferences.get('grid', {})
    
    # Calculate grid range based on current price and volatility
    current_price = decision.market_context.current_price
    volatility = decision.market_context.volatility
    
    # Grid range: ¬±volatility from current price
    price_min = current_price * (1 - volatility)
    price_max = current_price * (1 + volatility)
    
    num_levels = grid_prefs.get('num_levels', 7)  # Default 7 levels
    total_investment = float(decision.position_size_usd)
    profit_target = grid_prefs.get('profit_target_percent', 1.0)  # 1% per cycle
    
    # Start the strategy
    executor = get_strategy_executor()
    
    try:
        strategy_run = executor.start_strategy(
            account=self.account,
            strategy_type=StrategyType.GRID,
            config={
                'token_address': token_address,
                'token_symbol': decision.token_symbol,
                'price_range_min': str(price_min),
                'price_range_max': str(price_max),
                'num_levels': num_levels,
                'total_investment_usd': str(total_investment),
                'profit_target_percent': str(profit_target),
            }
        )
        
        logger.info(
            f"Started Grid strategy {strategy_run.strategy_id}: "
            f"{num_levels} levels in ${price_min:.4f}-${price_max:.4f} range"
        )
        
        # Log AI thought
        self._log_thought(
            decision_type='GRID_STRATEGY',
            confidence=decision.confidence_percent,
            reasoning=f"Bot selected Grid: High volatility ({volatility:.1%}), sideways trend, range ${price_min:.4f}-${price_max:.4f}"
        )
        
    except Exception as e:
        logger.error(f"Failed to start Grid strategy: {e}")
        # Fallback to spot buy
        self.trade_executor.execute_trade(decision)
```

---

#### 2. **`paper_trading/models/configuration.py`** - ADD STRATEGY PREFERENCES (~150 lines)

**New Model: `PaperStrategyPreferences`**

```python
class PaperStrategyPreferences(models.Model):
    """
    Strategy preferences for automated bot decision-making.
    
    Defines which strategies the bot can use and their parameters.
    """
    
    # Link to trading config
    config = models.OneToOneField(
        'PaperStrategyConfiguration',
        on_delete=models.CASCADE,
        related_name='strategy_preferences'
    )
    
    # Strategy Enablement
    enable_dca = models.BooleanField(default=False, help_text="Allow bot to use DCA strategies")
    enable_grid = models.BooleanField(default=False, help_text="Allow bot to use Grid strategies")
    enable_twap = models.BooleanField(default=False, help_text="Allow bot to use TWAP strategies")
    enable_vwap = models.BooleanField(default=False, help_text="Allow bot to use VWAP strategies")
    
    # DCA Preferences
    dca_num_intervals = models.IntegerField(default=5, validators=[MinValueValidator(2), MaxValueValidator(20)])
    dca_interval_hours = models.IntegerField(default=2, validators=[MinValueValidator(1), MaxValueValidator(24)])
    dca_min_amount_usd = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal('100.00'))
    
    # Grid Preferences
    grid_num_levels = models.IntegerField(default=7, validators=[MinValueValidator(3), MaxValueValidator(20)])
    grid_profit_target_percent = models.DecimalField(max_digits=5, decimal_places=2, default=Decimal('1.0'))
    grid_max_range_percent = models.DecimalField(max_digits=5, decimal_places=2, default=Decimal('10.0'))
    
    # Strategy Selection Thresholds
    volatility_threshold_grid = models.DecimalField(max_digits=5, decimal_places=3, default=Decimal('0.05'))  # 5%
    trend_strength_threshold_dca = models.DecimalField(max_digits=5, decimal_places=2, default=Decimal('70.0'))  # 70% confidence
    
    # Strategy Priority (when multiple strategies qualify)
    strategy_priority = models.JSONField(
        default=list,
        help_text="Priority order: ['GRID', 'DCA', 'SPOT']"
    )
    
    class Meta:
        db_table = 'paper_strategy_preferences'
        verbose_name = 'Strategy Preference'
        verbose_name_plural = 'Strategy Preferences'
    
    def __str__(self):
        enabled = []
        if self.enable_dca:
            enabled.append('DCA')
        if self.enable_grid:
            enabled.append('Grid')
        return f"Strategy Prefs: {', '.join(enabled) if enabled else 'Spot Only'}"
```

---

#### 3. **`paper_trading/constants.py`** - ADD STRATEGY DECISION CONSTANTS (~50 lines)

```python
class StrategyDecisionThresholds:
    """Thresholds for automated strategy selection."""
    
    # Grid Strategy Thresholds
    GRID_MIN_VOLATILITY = Decimal('0.05')  # 5% volatility required
    GRID_MIN_LIQUIDITY = Decimal('100000')  # $100k minimum liquidity
    GRID_VALID_TRENDS = ['sideways', 'range_bound']
    
    # DCA Strategy Thresholds
    DCA_MIN_CONFIDENCE = Decimal('70.0')  # 70% confidence required
    DCA_MIN_AMOUNT = Decimal('100.00')  # $100 minimum for DCA
    DCA_VALID_TRENDS = ['uptrend', 'strong_uptrend']
    
    # Spot Buy (fallback)
    SPOT_MIN_CONFIDENCE = Decimal('40.0')  # Lower bar for spot buys


class MarketTrend:
    """Market trend classifications for strategy selection."""
    
    STRONG_UPTREND = 'strong_uptrend'
    UPTREND = 'uptrend'
    SIDEWAYS = 'sideways'
    RANGE_BOUND = 'range_bound'
    DOWNTREND = 'downtrend'
    STRONG_DOWNTREND = 'strong_downtrend'
    
    ALL = [
        STRONG_UPTREND,
        UPTREND,
        SIDEWAYS,
        RANGE_BOUND,
        DOWNTREND,
        STRONG_DOWNTREND
    ]
```

---

### **Database Changes:**

#### **Migration 0007: Add Strategy Preferences**

```bash
python manage.py makemigrations paper_trading
# Creates: 0007_paperst strategy_preferences.py

python manage.py migrate paper_trading
# Applies: PaperStrategyPreferences table
```

---

### **Testing Plan:**

**Test 1: Strategy Selection Logic**
```python
# Django shell
from paper_trading.bot.market_analyzer import MarketAnalyzer
from paper_trading.intelligence.base import MarketContext, TradingDecision

# Create test decision with high volatility
context = MarketContext(
    volatility=0.08,  # 8% volatility
    trend='sideways',
    liquidity=Decimal('500000')
)

decision = TradingDecision(
    action='BUY',
    confidence_percent=75,
    market_context=context
)

# Should select GRID
strategy_type = analyzer._select_strategy('0x123...', decision)
print(f"Selected: {strategy_type}")  # Expected: GRID

# Change to uptrend with high confidence
context.trend = 'strong_uptrend'
strategy_type = analyzer._select_strategy('0x123...', decision)
print(f"Selected: {strategy_type}")  # Expected: DCA
```

**Test 2: End-to-End Bot Run**
```bash
# Start bot with strategies enabled
python manage.py run_paper_bot --account=test --intel-level=5

# Watch logs for:
# "Selected GRID strategy: volatility=0.08, trend=sideways"
# "Started Grid strategy abc-123: 7 levels in $2000-$2200 range"
# "Selected DCA strategy: trend=strong_uptrend, confidence=75%"
# "Started DCA strategy def-456: 5 buys of $20 every 2h"
```

**Test 3: Configuration UI Integration**
```python
# Verify preferences are used
prefs = PaperStrategyPreferences.objects.get(config=config)
prefs.enable_grid = True
prefs.enable_dca = True
prefs.save()

# Bot should now select strategies automatically
```

---

### **Success Criteria:**

‚úÖ **Bot Integration:**
- [ ] Bot can select between SPOT, DCA, and GRID strategies
- [ ] Selection logic considers volatility, trend, liquidity
- [ ] Strategy preferences from config are respected
- [ ] Fallback to spot buy if strategy fails

‚úÖ **Code Quality:**
- [ ] Type hints on all new methods
- [ ] Comprehensive docstrings
- [ ] Structured logging for debugging
- [ ] Error handling with fallbacks

‚úÖ **Testing:**
- [ ] Unit tests for `_select_strategy()`
- [ ] Integration test with live bot
- [ ] Strategy execution verified
- [ ] AI thought logs generated correctly

‚úÖ **Documentation:**
- [ ] Updated `bot/README` with strategy selection
- [ ] Configuration guide for strategy preferences
- [ ] Decision matrix documented

---

## üìä **Day 5 Summary (When Complete):**

**Files Modified:** 3 files (~600 lines)
- `market_analyzer.py` - Strategy selection integration
- `models/configuration.py` - Strategy preferences model
- `constants.py` - Strategy decision thresholds

**Database Changes:** 
- Migration 0007: PaperStrategyPreferences table
- 1 new table with 15+ fields

**New Capabilities:**
- ‚úÖ Bot intelligently selects entry strategy
- ‚úÖ DCA for strong trends + large positions
- ‚úÖ Grid for volatile + range-bound markets
- ‚úÖ Spot buy as reliable fallback
- ‚úÖ User configures preferences, bot decides execution

**Competitive Position:**
- Unibot/Maestro: Fixed spot buys only
- **Your Bot:** Adaptive strategy selection based on market conditions ‚≠ê‚≠ê‚≠ê

---

## üî≤ **Days 6-7: Bot Configuration UI - TODO**

**Status:** üî≤ Not Started  
**Estimated Time:** ~6 hours

### **Goal:** 
Build UI for configuring bot strategy preferences (NOT manual strategy placement).

**What to Build:**

#### **1. Strategy Preferences Panel**
Configuration screen for bot strategy settings:
- Enable/disable each strategy type (DCA, Grid, TWAP, VWAP)
- Configure strategy parameters:
  - DCA: Number of intervals, interval duration
  - Grid: Number of levels, profit target
  - TWAP/VWAP: Order splitting preferences
- Set strategy selection thresholds
- Strategy priority ordering

#### **2. Active Strategies Dashboard**
View strategies currently running:
- List of active strategies (started by bot automatically)
- Progress indicators
- Performance metrics (ROI, filled orders)
- Control buttons (pause/resume/cancel)
- Real-time updates via WebSocket

#### **3. Strategy History View**
Historical performance of bot's strategy selections:
- Which strategies bot selected over time
- Success rate by strategy type
- P&L by strategy type
- Decision accuracy tracking

---

## üéØ **UPDATED PROGRESS TRACKER**

### **Overall Phase 7B Status:**
- **Days Completed:** 4 of 15 (26.7%)
- **Code Written:** ~3,011 lines of ~3,200 total (94.1%)
- **Time Invested:** ~12.5 hours of ~55 total (22.7%)

### **Week 1 Progress:**
- ‚úÖ Day 1: Strategy Framework & Models - **COMPLETE**
- ‚úÖ Day 2: DCA Strategy Implementation - **COMPLETE**
- ‚úÖ Day 3: Grid Trading Strategy - **COMPLETE**
- ‚úÖ Day 4: Strategy Executor Service - **COMPLETE**
- üîÑ Day 5: **Bot Integration & Strategy Selection** - **NEXT** ‚≠ê‚≠ê‚≠ê
- üî≤ Day 6-7: Bot Configuration UI
- üî≤ Day 8: Week 1 Testing & Documentation

### **Week 2 Progress:**
- üî≤ Day 9: TWAP Strategy
- üî≤ Day 10: VWAP Strategy
- üî≤ Day 11: Custom Strategy Builder
- üî≤ Day 12: Backtesting Engine
- üî≤ Day 13: Backtesting UI & Reports
- üî≤ Day 14: Integration Testing & Polish
- üî≤ Day 15: Final Testing & Documentation

---

## üéØ **Next Steps:**

**Immediate (Day 5 - Bot Integration):**
1. Refactor `market_analyzer.py` with strategy selection
2. Add `_select_strategy()` method with decision matrix
3. Add `_start_dca_strategy()` helper
4. Add `_start_grid_strategy()` helper
5. Create `PaperStrategyPreferences` model
6. Add strategy decision constants
7. Run database migration
8. Test strategy selection logic
9. Verify end-to-end bot operation

**Next (Days 6-7 - Configuration UI):**
- Build strategy preferences configuration panel
- Create active strategies dashboard
- Add strategy history view
- Integrate with WebSocket updates
- Test bot configuration flow

---

**Last Updated:** November 11, 2025  
**Current Phase:** 7B - Advanced Strategies  
**Overall Progress:** Day 4 Complete (26.7%) | Day 5 Bot Integration Next  
**Status:** üö® CRITICAL REFACTOR - Strategy Integration Into Bot

**‚ö†Ô∏è IMPORTANT:** Before building UI (Days 6-7), we must complete Day 5 (Bot Integration) to ensure the UI configures the correct architecture (automated strategies, not manual placement).

**When ready to start, say: "Proceed with Day 5 - Bot Integration"** ü§ñ